<!doctype html>
<html lang="zh-tw">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>安全閥計算器（單頁 Web App）</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#06b6d4;--muted:#94a3b8;--glass: rgba(255,255,255,0.03)}
    html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:linear-gradient(180deg,#071025 0%, #071827 100%);color:#e6eef6}
    .container{max-width:980px;margin:28px auto;padding:20px}
    header{display:flex;align-items:center;gap:16px}
    h1{margin:0;font-size:20px}
    p.lead{margin:6px 0 18px;color:var(--muted);font-size:13px}
    .card{background:var(--card);border-radius:12px;padding:18px;box-shadow:0 6px 18px rgba(2,6,23,0.6);}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    label{display:block;font-size:13px;margin-bottom:6px;color:var(--muted)}
    input[type="number"],select,input[type="text"]{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:var(--glass);color:inherit;font-size:14px}
    .full{grid-column:1/-1}
    button{background:var(--accent);border:none;color:#022528;padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer}
    .row{display:flex;gap:8px}
    .result{margin-top:14px;padding:12px;border-radius:8px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03)}
    .small{font-size:12px;color:var(--muted)}
    footer{margin-top:14px;color:var(--muted);font-size:12px}
    .hint{background:rgba(6,182,212,0.06);padding:8px;border-radius:8px;color:var(--accent);font-weight:600}
    @media (max-width:700px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div style="width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,#022b35,#064c59);display:flex;align-items:center;justify-content:center;font-weight:700;color:#aef6ff">SV</div>
      <div>
        <h1>安全閥計算器（MVP）</h1>
        <p class="lead">提供安全閥常見的單位轉換、理想氣體的容積⇄質量流率換算、及簡易報告匯出。此為示範版，嚴格簽核或法規報告請委由工程師完成。</p>
      </div>
    </header>

    <section class="card" style="margin-top:14px">
      <div class="grid">
	<div class="row">
          <div style="flex:1">
            <label>流體類型</label>
            <select id="fluidType">
              <option value="gas">氣體（理想氣體近似）</option>
              <option value="liquid">液體（不可壓縮）</option>
              <option value="steam">蒸氣（僅供概估）</option>
            </select>
          </div>
          <div style="flex:1">
            <label>欲輸入的流量類型</label>
            <select id="flowKind">
              <option value="vol">體積流率 (vol)</option>
              <option value="mass">質量流率 (mass)</option>
            </select>
          </div>
	</div>

	<div class="row">
          <div>
            <label>流量數值</label>
            <input id="flowValue" type="number" step="any" value="1000">
          </div>
          <div style="width:220px;">
            <label>流量單位</label>
            <select id="flowUnit">
              <optgroup label="體積流率">
		<option value="m3/h">m³/h</option>
		<option value="L/min">L/min</option>
		<option value="Nm3/h">Nm³/h (標準)</option>
		<option value="scfm">SCFM (標準英制)</option>
              </optgroup>
              <optgroup label="質量流率">
		<option value="kg/h">kg/h</option>
		<option value="kg/s">kg/s</option>
		<option value="lb/hr">lb/hr</option>
              </optgroup>
            </select>
          </div>
	</div>
	<div class="row">
          <div>
            <label>欲轉換到的單位</label>
            <select id="targetUnit">
              <option value="kg/h">kg/h</option>
              <option value="m3/h">m³/h</option>
              <option value="Nm3/h">Nm³/h</option>
              <option value="scfm">SCFM</option>
              <option value="L/min">L/min</option>
              <option value="lb/hr">lb/hr</option>
            </select>
          </div>
	</div>
	<div class="row">
          <div>
            <label>壓力 (數值)</label>
            <input id="pressure" type="number" step="any" value="1.01325">
          </div>
          <div style="width:220px;">
            <label>壓力單位</label>
            <select id="pressureUnit">
              <option value="bar">bar</option>
              <option value="kpa">kPa</option>
              <option value="pa">Pa</option>
              <option value="mpa">MPa</option>
              <option value="psia">psia</option>
            </select>
          </div>
	</div>
      </div>
      <div class="grid">
	<div class="row">
	  <div>
            <label>溫度 (數值)</label>
            <input id="temperature" type="number" step="any" value="15">
          </div>
          <div style="width:220px;">
            <label>溫度單位</label>
            <select id="temperatureUnit">
              <option value="C">°C</option>
              <option value="K">K</option>
              <option value="F">°F</option>
            </select>
          </div>
	</div>
	<div class="row">
          <div>
            <label>分子量 (M, g/mol) — 氣體用</label>
            <input id="molarMass" type="number" step="any" value="28.97">
          </div>
          <div style="width:220px;">
            <label>標準狀態 (選擇標準參考條件)</label>
            <select id="stdChoice">
              <option value="0C1atm">標準：0°C, 1.01325 bar</option>
              <option value="15C1atm">標準：15°C, 1.01325 bar</option>
              <option value="20C1atm">標準：20°C, 1.01325 bar</option>
            </select>
          </div>
	</div>

        <div class="full">
          <label class="small">說明</label>
          <div class="small">此工具使用「理想氣體」近似來做氣體質量⇄體積換算。蒸氣與高壓氣體可能有顯著偏差；若需法規/簽核級計算，請委託工程師以專業軟體或標準方法計算（ASME、API 等）。</div>
        </div>
	
      </div> <!-- grid -->

      <div style="display:flex;gap:10px;margin-top:12px">
        <button id="calcBtn">計算 / 轉換</button>
        <button id="copyBtn" style="background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)">複製結果</button>
        <button id="downloadBtn" style="background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)">下載簡易報告 (TXT)</button>
      </div>

      <div id="resultArea" class="result" aria-live="polite" style="display:none">
        <div id="resultText"></div>
        <div style="margin-top:8px" class="small">備註：此為估算工具，計算公式請參考物理基礎；稽核報告與簽核圖面需另行委託專業工程師。</div>
      </div>

    </section>

    <footer>
      <div class="small" style="margin-top: 14px; text-align: center;">
        &copy; 2023 各申機械設計工作室. 本專案依據 GPLv3 許可證發布。
	<a href="https://www.gnu.org/licenses/gpl-3.0.html" target="_blank" style="color:var(--muted); text-decoration: underline;">了解更多</a>
      </div>
      <div class="small" style="text-align: center; margin-top: 6px;">
	專案原始碼：
	<a href="https://github.com/roscoe-tw/safety-valve-calculator/" target="_blank" style="color:var(--muted); text-decoration: underline;">在 GitHub 查看</a>
      </div>
    </footer>
  </div>

  <script>
    // 常數與工具函數
    const R_universal = 8.314462618; // J/mol/K
    
    function toKelvin(val, unit){
      if(unit==='C') return val + 273.15;
      if(unit==='K') return val;
      if(unit==='F') return (val - 32) * 5/9 + 273.15;
      return val;
    }
    
    function pressureToPa(p, unit){
      switch(unit){
        case 'bar': return p * 1e5;
        case 'kpa': return p * 1e3;
        case 'pa': return p;
        case 'mpa': return p * 1e6;
        case 'psia': return (p - 14.6959) * 6894.757; // approx: psia to Pa (note: psia includes atm; this is simplistic)
        default: return p;
      }
    }
    
    // 換算 SCFM <-> m3/h （簡單近似，SCFM = Standard cubic feet per minute at 1 atm & 60°F or 60°F?；此處採 60°F=15.556°C 為常用）
    function m3h_to_scfm(m3h, std){
      // 1 m3 = 35.3146667 ft3 ; 1 hour = 60 min
      return m3h * 35.3146667 / 60;
    }
    function scfm_to_m3h(scfm){
      return scfm * 60 / 35.3146667;
    }
    
    // 體積 ↔ 質量（氣體，理想氣體）：rho = p*M/(R*T)  (M in kg/mol)
    function idealGasDensity(p_Pa, T_K, M_kgpermol){
      return p_Pa * M_kgpermol / (R_universal * T_K); // kg/m3
    }
    
    // 單位轉換（體積流率的基礎單位：m3/h）
    function flowTo_m3h(value, unit){
      switch(unit){
        case 'm3/h': return value;
        case 'L/min': return value * 0.001 * 60;
        case 'Nm3/h': return value; // treat as m3/h at standard
        case 'scfm': return scfm_to_m3h(value);
        default: return value;
      }
    }
    function m3h_to_target(value_m3h, target){
      switch(target){
        case 'm3/h': return value_m3h;
        case 'L/min': return value_m3h * 1000 / 60;
        case 'Nm3/h': return value_m3h;
        case 'scfm': return m3h_to_scfm(value_m3h);
        case 'kg/h': // need density external
        case 'lb/hr':
        default:
          return value_m3h;
      }
    }
    
    // 質量流率單位處理
    function massTo_kgph(val, unit){
      switch(unit){
        case 'kg/h': return val;
        case 'kg/s': return val * 3600;
        case 'lb/hr': return val * 0.45359237;
        default: return val;
      }
    }
    function kgph_to_massTarget(val_kgph, target){
      switch(target){
        case 'kg/h': return val_kgph;
        case 'kg/s': return val_kgph / 3600;
        case 'lb/hr': return val_kgph / 0.45359237;
        default: return val_kgph;
      }
    }
    
    // main
    document.getElementById('calcBtn').addEventListener('click', ()=>{
      const fluid = document.getElementById('fluidType').value;
      const flowKind = document.getElementById('flowKind').value;
      const flowVal = Number(document.getElementById('flowValue').value);
      const flowUnit = document.getElementById('flowUnit').value;
      const target = document.getElementById('targetUnit').value;
      const pVal = Number(document.getElementById('pressure').value);
      const pUnit = document.getElementById('pressureUnit').value;
      const tVal = Number(document.getElementById('temperature').value);
      const tUnit = document.getElementById('temperatureUnit').value;
      const M_gpmol = Number(document.getElementById('molarMass').value);
    
      // validation
      if(isNaN(flowVal) || isNaN(pVal) || isNaN(tVal) || isNaN(M_gpmol)){
        alert('請輸入所有數值欄位。');
        return;
      }
    
      // convert pressure/temp to SI
      const pPa = pressureToPa(pVal, pUnit);
      const T_K = toKelvin(tVal, tUnit);
    
      let resultNote = '';
      let out = '';
    
      if(fluid === 'gas'){
        // if input is volumetric, convert to m3/h, then to mass using ideal gas
        if(flowKind === 'vol'){
          const vol_m3h = flowTo_m3h(flowVal, flowUnit);
          const M = M_gpmol / 1000.0; // kg/mol
          const rho = idealGasDensity(pPa, T_K, M);
          const mass_kgph = rho * vol_m3h;
    
          // target formatting
          let targetStr = '';
          if(['kg/h','kg/s','lb/hr'].includes(target)){
            const conv = kgph_to_massTarget(mass_kgph, target);
            targetStr = `${conv.toExponential(6)} ${target}`;
          } else {
            // convert m3/h to target vol unit
            const vconv = m3h_to_target(vol_m3h, target);
            targetStr = `${vconv.toExponential(6)} ${target}`;
          }
    
          out += `輸入：${flowVal} ${flowUnit}（視為體積流率）\n`;
          out += `在 p=${pVal} ${pUnit}, T=${tVal} ${tUnit}，分子量 M=${M_gpmol} g/mol 的理想氣體：\n`;
          out += `密度 (理想氣體估算) = ${rho.toFixed(6)} kg/m³\n`;
          out += `質量流率 = ${mass_kgph.toFixed(6)} kg/h\n`;
          out += `目標單位換算結果： ${targetStr}\n`;
    
        } else {
          // input is mass
          const mass_kgph = massTo_kgph(flowVal, flowUnit);
          const M = M_gpmol / 1000.0;
          const rho = idealGasDensity(pPa, T_K, M);
          const vol_m3h = mass_kgph / rho;
    
          let targetStr = '';
          if(['m3/h','L/min','Nm3/h','scfm'].includes(target)){
            const vconv = m3h_to_target(vol_m3h, target);
            targetStr = `${vconv.toExponential(6)} ${target}`;
          } else {
            const mconv = kgph_to_massTarget(mass_kgph, target);
            targetStr = `${mconv.toExponential(6)} ${target}`;
          }
    
          out += `輸入：${flowVal} ${flowUnit}（視為質量流率）\n`;
          out += `在 p=${pVal} ${pUnit}, T=${tVal} ${tUnit}，分子量 M=${M_gpmol} g/mol 的理想氣體：\n`;
          out += `密度 (理想氣體估算) = ${rho.toFixed(6)} kg/m³\n`;
          out += `體積流率 = ${vol_m3h.toFixed(6)} m³/h\n`;
          out += `目標單位換算結果： ${targetStr}\n`;
        }
    
      } else if(fluid === 'liquid'){
        // liquids: treat volumetric <-> mass using density input? we didn't get density input, so ask user to interpret mass directly
        out += '液體模式：僅支援單位轉換。若要質量⇄體積，請提供密度（kg/m³）。\n';
        // try basic conversion if units are volumetric
        if(flowKind === 'vol'){
          const v_m3h = flowTo_m3h(flowVal, flowUnit);
          if(['m3/h','L/min','Nm3/h','scfm'].includes(target)){
            const vconv = m3h_to_target(v_m3h, target);
            out += `體積流率換算 = ${vconv.toExponential(6)} ${target}\n`;
          } else {
            out += '需要密度以換算質量流率。\n';
          }
        } else {
          const mass = massTo_kgph(flowVal, flowUnit);
          if(['kg/h','kg/s','lb/hr'].includes(target)){
            const mconv = kgph_to_massTarget(mass, target);
            out += `質量流率換算 = ${mconv.toExponential(6)} ${target}\n`;
          } else {
            out += '需要密度以換算體積流率。\n';
          }
        }
    
      } else if(fluid === 'steam'){
        out += '蒸氣模式：此版僅提供非常粗略估算。蒸氣特性建議使用專業蒸汽表或工程軟體。\n';
        // attempt ideal gas approximate
        if(flowKind === 'vol'){
          const vol_m3h = flowTo_m3h(flowVal, flowUnit);
          const M = M_gpmol / 1000.0;
          const rho = idealGasDensity(pPa, T_K, M);
          const mass_kgph = rho * vol_m3h;
          out += `以理想氣體近似：質量流率 ~ ${mass_kgph.toFixed(6)} kg/h\n`;
        } else {
          out += '輸入質量流率可直接轉換單位。\n';
        }
      }
    
      // show result
      const area = document.getElementById('resultArea');
      const text = document.getElementById('resultText');
      area.style.display = 'block';
      text.textContent = out;
    
      // store last result for copy / download
      window._lastReport = {
        title: '安全閥計算器 - 簡易報告',
        timestamp: new Date().toISOString(),
        content: out
      };
    });
    
    document.getElementById('copyBtn').addEventListener('click', ()=>{
      if(!window._lastReport){ alert('尚無計算結果，請先執行「計算 / 轉換」。'); return; }
      navigator.clipboard.writeText(`${window._lastReport.title}\n${window._lastReport.timestamp}\n\n${window._lastReport.content}`)
        .then(()=>{ alert('計算結果已複製到剪貼簿。'); })
        .catch(()=>{ alert('無法寫入剪貼簿。'); });
    });
    
    document.getElementById('downloadBtn').addEventListener('click', ()=>{
      if(!window._lastReport){ alert('尚無計算結果，請先執行「計算 / 轉換」。'); return; }
      const blob = new Blob([`${window._lastReport.title}\n${window._lastReport.timestamp}\n\n${window._lastReport.content}\n\n備註：此為估算工具，簽核與法規計算需專業工程師處理。`], {type:'text/plain;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'safety_valve_report.txt';
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    });
    
  </script>
</body>
</html>
